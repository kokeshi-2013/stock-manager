rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===== リスト（v3） =====
    match /lists/{listId} {
      // 認証済みユーザーなら読み取り可能（共有コードで検索するため）
      allow read: if request.auth != null;

      // 認証済みユーザーなら新規作成可能（自分がメンバーに含まれていること）
      allow create: if request.auth != null
                    && request.auth.uid in request.resource.data.memberUids;

      // 認証済みユーザーなら更新可能（メンバー追加 = リスト参加のため）
      allow update: if request.auth != null
                    && (request.auth.uid in resource.data.memberUids
                        || request.auth.uid in request.resource.data.memberUids);

      // メンバーなら削除可能
      allow delete: if request.auth != null
                    && request.auth.uid in resource.data.memberUids;

      // ----- リスト内のアイテム -----
      match /items/{itemId} {
        // メンバーのみ読み書き可能
        allow read, write: if request.auth != null
                          && request.auth.uid in
                             get(/databases/$(database)/documents/lists/$(listId)).data.memberUids;
      }
    }

    // ===== 旧家族グループ（v2互換、90日後に削除予定） =====
    match /familyGroups/{groupId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if request.auth != null
                    && resource.data.createdBy == request.auth.uid;

      match /items/{itemId} {
        allow read, write: if request.auth != null;
      }
    }

    // ===== 使用量モニター =====
    match /_usage/{docId} {
      allow read, write: if request.auth != null;
    }
  }
}
