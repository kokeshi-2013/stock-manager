rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===== 家族グループ =====
    match /familyGroups/{groupId} {
      // 認証済みユーザーなら読み取り可能（招待コードで検索するため）
      allow read: if request.auth != null;

      // 認証済みユーザーなら新規作成可能
      allow create: if request.auth != null;

      // 認証済みユーザーなら更新可能（メンバー追加 = グループ参加のため）
      allow update: if request.auth != null;

      // 作成者のみ削除可能
      allow delete: if request.auth != null
                    && resource.data.createdBy == request.auth.uid;

      // ----- グループ内のアイテム -----
      match /items/{itemId} {
        // グループのメンバーのみ読み書き可能
        allow read, write: if request.auth != null
                          && request.auth.uid in get(/databases/$(database)/documents/familyGroups/$(groupId)).data.memberUids;
      }
    }

    // ===== 使用量モニター =====
    match /_usage/{docId} {
      allow read, write: if request.auth != null;
    }
  }
}
